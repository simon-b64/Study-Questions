<div class="container py-4">
    @if (currentQuestion()) {
        <!-- Header with Progress -->
        <div class="row mb-4">
            <div class="col">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <button class="btn btn-outline-secondary btn-sm" (click)="exitSession()">
                        <i class="bi bi-arrow-left me-2"></i>Zur√ºck
                    </button>
                    <div class="text-center">
                        <small class="text-muted">Frage {{ currentQuestionIndex() + 1 }} von {{ questionsQueue().length }}</small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-primary">
                            <i class="bi bi-bullseye me-1"></i>{{ sessionAccuracy() }}% Genauigkeit
                        </span>
                    </div>
                </div>
                <!-- Progress Bar -->
                <div class="progress mb-3 progress-thin">
                    <div class="progress-bar bg-primary"
                         [style.width.%]="((currentQuestionIndex() + 1) / questionsQueue().length) * 100"
                         role="progressbar"
                         [attr.aria-valuenow]="currentQuestionIndex() + 1"
                         [attr.aria-valuemin]="0"
                         [attr.aria-valuemax]="questionsQueue().length">
                    </div>
                </div>
            </div>
        </div>
        <!-- Question Card -->
        <div class="row">
            <div class="col-12 col-lg-10 offset-lg-1">
                <div class="card shadow-lg border-0">
                    <!-- Topic Badge -->
                    <div class="card-header bg-white border-bottom">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge bg-light text-dark">
                                <i class="bi bi-tag me-1"></i>{{ currentQuestion()!.groupName }}
                            </span>
                            @if (currentQuestion()!.progress.masteryLevel !== 'NOT_STARTED') {
                                <small class="text-muted">
                                    <i class="bi bi-clock-history me-1"></i>
                                    Versuche: {{ currentQuestion()!.progress.totalAttempts }}
                                </small>
                            }
                        </div>
                    </div>
                    <!-- Question -->
                    <div class="card-body p-3 p-md-5">
                        <h3 class="card-title mb-4">{{ currentQuestion()!.question.question }}</h3>
                        <!-- Answer Options -->
                        <div class="d-grid gap-3 mb-4">
                            @for (shuffled of currentQuestion()!.shuffledAnswers; track shuffled.originalIndex; let i = $index) {
                                <button
                                    class="btn btn-lg text-start answer-button"
                                    [class.btn-outline-primary]="!isAnswerSelected(i) && !showResult()"
                                    [class.btn-primary]="isAnswerSelected(i) && !showResult()"
                                    [class.btn-success]="showResult() && shuffled.answer.correct"
                                    [class.btn-danger]="showResult() && isAnswerSelected(i) && !shuffled.answer.correct"
                                    [class.btn-outline-secondary]="showResult() && !isAnswerSelected(i) && !shuffled.answer.correct"
                                    [disabled]="showResult()"
                                    (click)="selectAnswer(i)"
                                    [attr.aria-pressed]="isAnswerSelected(i)"
                                    [attr.aria-label]="'Antwort: ' + shuffled.answer.text">
                                    <div class="d-flex align-items-center">
                                        <span class="me-3 fs-5">
                                            @if (!showResult()) {
                                                <i class="bi" [class.bi-square]="!isAnswerSelected(i)" [class.bi-x-square]="isAnswerSelected(i)"></i>
                                            } @else if (shuffled.answer.correct) {
                                                <i class="bi bi-check-circle-fill"></i>
                                            } @else if (isAnswerSelected(i) && !shuffled.answer.correct) {
                                                <i class="bi bi-x-circle-fill"></i>
                                            } @else {
                                                <i class="bi bi-circle"></i>
                                            }
                                        </span>
                                        <span class="flex-grow-1">{{ shuffled.answer.text }}</span>
                                    </div>
                                </button>
                            }
                        </div>
                        <!-- Hint (before answering) -->
                        @if (!showResult() && currentQuestion()!.question.hint) {
                            <div class="hint-wrapper" [class.hint-expanded]="hintVisible()">
                                <button
                                    class="hint-toggle"
                                    type="button"
                                    [attr.aria-expanded]="hintVisible()"
                                    aria-controls="hint-panel"
                                    (click)="hintVisible.set(!hintVisible())">
                                    <i class="bi bi-lightbulb" aria-hidden="true"></i>
                                    <span>{{ hintVisible() ? 'Hinweis verbergen' : 'Hinweis anzeigen' }}</span>
                                    <i class="bi hint-chevron" [class.bi-chevron-down]="!hintVisible()" [class.bi-chevron-up]="hintVisible()" aria-hidden="true"></i>
                                </button>
                                <div id="hint-panel" [ngbCollapse]="!hintVisible()">
                                    <div class="hint-content" role="note">
                                        {{ currentQuestion()!.question.hint }}
                                    </div>
                                </div>
                            </div>
                        }
                        <!-- Result Section -->
                        @if (showResult()) {
                            <div class="mt-4">
                                <!-- Correct Answer -->
                                @if (isAnswerCorrect()) {
                                    <div class="alert alert-success d-flex align-items-start mb-3">
                                        <i class="bi bi-check-circle-fill me-2 fs-4 mt-1"></i>
                                        <div>
                                            <h5 class="alert-heading mb-2">Richtig! üéâ</h5>
                                            <p class="mb-0">{{ currentQuestion()!.question.reason }}</p>
                                        </div>
                                    </div>
                                    <!-- Mastery Progress -->
                                    @if (currentQuestion()!.progress.consecutiveCorrect + 1 < 3) {
                                        <div class="alert alert-light border">
                                            <div class="d-flex align-items-center justify-content-between">
                                                <small class="text-muted">
                                                    <i class="bi bi-trophy me-1"></i>
                                                    Noch {{ 3 - (currentQuestion()!.progress.consecutiveCorrect + 1) }} richtige Antwort(en) bis "Gemeistert"
                                                </small>
                                                <div class="progress progress-mastery">
                                                    <div class="progress-bar bg-success"
                                                         [style.width.%]="((currentQuestion()!.progress.consecutiveCorrect + 1) / 3) * 100">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    } @else {
                                        <div class="alert alert-success border-success">
                                            <i class="bi bi-star-fill me-2"></i>
                                            <strong>Gemeistert!</strong> Diese Frage hast du jetzt voll im Griff!
                                        </div>
                                    }
                                } @else {
                                    <!-- Wrong Answer -->
                                    <div class="alert alert-danger d-flex align-items-start mb-3">
                                        <i class="bi bi-x-circle-fill me-2 fs-4 mt-1"></i>
                                        <div class="w-100">
                                            <h5 class="alert-heading mb-2">Nicht ganz richtig</h5>
                                            <p class="mb-2">{{ currentQuestion()!.question.reason }}</p>

                                            <!-- Show what user selected vs what's correct -->
                                            <div class="mt-3">
                                                <h6 class="mb-2"><strong>Deine Auswahl:</strong></h6>
                                                <ul class="mb-2">
                                                    @for (shuffled of currentQuestion()!.shuffledAnswers; track shuffled.originalIndex; let i = $index) {
                                                        @if (isAnswerSelected(i)) {
                                                            <li>
                                                                @if (shuffled.answer.correct) {
                                                                    <i class="bi bi-check-circle-fill text-success me-1"></i>
                                                                    <span>{{ shuffled.answer.text }}</span>
                                                                    <span class="badge bg-success ms-2">Richtig</span>
                                                                } @else {
                                                                    <i class="bi bi-x-circle-fill text-danger me-1"></i>
                                                                    <span>{{ shuffled.answer.text }}</span>
                                                                    <span class="badge bg-danger ms-2">Falsch gew√§hlt</span>
                                                                }
                                                            </li>
                                                        }
                                                    }
                                                </ul>

                                                <!-- Show missed correct answers -->
                                                @if (missedCorrectAnswers().length > 0) {
                                                    <h6 class="mb-2 mt-3"><strong>Nicht gew√§hlt (aber richtig):</strong></h6>
                                                    <ul class="mb-0">
                                                        @for (answer of missedCorrectAnswers(); track answer.text) {
                                                            <li class="text-warning">
                                                                <i class="bi bi-exclamation-circle-fill me-1"></i>
                                                                <span>{{ answer.text }}</span>
                                                            </li>
                                                        }
                                                    </ul>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                    <div class="alert alert-light border">
                                        <i class="bi bi-info-circle me-2"></i>
                                        <small class="text-muted">
                                            Diese Frage wird bald wieder erscheinen, damit du sie √ºben kannst.
                                        </small>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                    <!-- Actions -->
                    <div class="card-footer bg-white border-top">
                        <div class="d-flex justify-content-between gap-2">
                            @if (!showResult()) {
                                <button
                                    class="btn btn-outline-secondary btn-lg"
                                    (click)="exitSession()">
                                    Abbrechen
                                </button>
                                <button
                                    class="btn btn-primary btn-lg px-3 px-sm-5"
                                    [disabled]="selectedAnswers().length === 0"
                                    (click)="submitAnswer()">
                                    <i class="bi bi-check-lg me-2"></i>Antwort best√§tigen
                                </button>
                            } @else {
                                <div></div>
                                @if (hasMoreQuestions()) {
                                    <button
                                        class="btn btn-primary btn-lg px-3 px-sm-5"
                                        (click)="nextQuestion()">
                                        N√§chste Frage
                                        <i class="bi bi-arrow-right ms-2"></i>
                                    </button>
                                } @else {
                                    <button
                                        class="btn btn-success btn-lg px-5"
                                        (click)="finishSession()">
                                        <i class="bi bi-check-circle me-2"></i>Session beenden
                                    </button>
                                }
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Session Stats -->
        <div class="row mt-4">
            <div class="col-12 col-lg-10 offset-lg-1">
                <div class="card bg-light border-0">
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="text-muted small">Beantwortet</div>
                                <div class="fs-4 fw-bold">{{ sessionStats().totalAnswered }}</div>
                            </div>
                            <div class="col-4">
                                <div class="text-muted small">Richtig</div>
                                <div class="fs-4 fw-bold text-success">{{ sessionStats().correctAnswers }}</div>
                            </div>
                            <div class="col-4">
                                <div class="text-muted small">Falsch</div>
                                <div class="fs-4 fw-bold text-danger">{{ sessionStats().incorrectAnswers }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    } @else {
        <!-- No questions available -->
        <div class="row">
            <div class="col-12 col-lg-8 offset-lg-2">
                <div class="alert alert-warning">
                    <h4 class="alert-heading">Keine Fragen verf√ºgbar</h4>
                    <p>Es konnten keine Fragen geladen werden.</p>
                    <hr>
                    <button class="btn btn-primary" (click)="finishSession()">
                        Zur√ºck zur Startseite
                    </button>
                </div>
            </div>
        </div>
    }
</div>
